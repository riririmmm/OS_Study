## 12-1. 동기화란

- 협력하여 실행되는 프로세스들 실행 순서 & 자원 일관성 보장 위해 **동기화** 필수
- **프로세스 동기화**: 프로세스들 사이 수행 시기를 맞추는 것
    - 실행 순서 제어: 프로세스를 올바른 순서대로 실행
    - 상호 배제: 동시에 접근해서는 안 되는 자원에 하나의 프로세스만 접근하게 하기
- **생산자와 소비자 문제**: 생산하는 프로세스인 생산자 & 소비하는 프로세스인 소비자 구성
    - *총합*이라는 데이터 공유
    - 생산자
        
        ```java
        생산자 () {
        	버퍼에 데이터 삽입
        	'총합' 변수 1 증가
        }
        ```
        
    - 소비자
        
        ```java
        소비자() {
        	버퍼에서 데이터 빼내기
        	'총합' 변수 1 감소
        }
        ```
        
    - 동시에 접근해서는 안 되는 자원(총합)에 동시에 접근 시 오류 발생 가능
- **공유 자원**: 공동으로 이용하는 변수, 파일, 장치 등의 자원. 전역변수, 파일, 입출력장치, 보조기억장치 모두 가능
- **임계 구역**: 동시에 실행하면 문제가 발생하는 자원에 접근하는 코드 영역
    - 두 개 이상의 프로세스가 임계 구역에 진입하고자 한다면 둘 중 하나는 대기해야 함
    
    <img width=65% alt="image" src="https://github.com/user-attachments/assets/e21ea8ea-ab62-4192-a896-ba5cecc35ea4" />

    
- **레이스 컨디션**: 두 개 이상의 프로세스가 동시에 실행되면 안 되는 영역인 임계 구역에서 잘못된 실행으로 인해 여러 프로세스가 동시 다발적으로 임계 구역의 코드를 실행해 발생하는 문제
- 상호 배제 위한 동기화 위해 지켜져야 할 원칙
    - **상호 배제**: 한 프로세스가 임계 구역에 진입했다면 다른 프로세스는 임계 구역에 진입 불가능
    - **진행**: 임계 구역에 어떤 프로세스도 진입하지 않았다면 임계 구역에 진입하고자 하는 프로세스는 진입 가능해야 함
    - **유한 대기**: 한 프로세스가 임계 구역에 진입하고자 한다면 그 프로세스는 언젠가는 임계 구역에 진입 가능해야 함

### 확인 문제

- #1. 동기화의 의미에 대한 옳은 설명을 다음 보기에서 찾아 쓰세요.
    
    > `보기` 상호 배제, 실행 순서 제어, 임계 구역
    > 
    - (   ①   )를 위한 동기화: 프로세스를 올바른 순서대로 실행하기
    - (   ②   )를 위한 동기화: 동시에 접근해서는 안 되는 자원에 하나의 프로세스만 접근하게 하기
    - 정답: ① 실행 순서 제어, ② 상호 배제
- #2. 임계 구역에 대한 설명으로 옳지 않은 것을 고르세요.
    1. 임계 구역에서 여러 개의 프로세스가 동시에 실행해도 무방합니다.
    2. 임계 구역에서 여러 프로세스가 동시에 실행할 경우 레이스 컨디션이 발생합니다.
    3. 임계 구역에서 실행되는 프로세스가 있다면 다른 프로세스는 기다려야 합니다.
    4. 운영체제는 임계 구역을 관리합니다.
    - 정답: 1번

## 12-2. 동기화 기법

- **뮤텍스 락**: 동시에 접근해서는 안 되는 자원에 동시에 접근하지 않도록 만드는 도구
    - 상호 배제를 위한 동기화 도구
    - 단순한 구현 - acquire, release 함수 및 lock 전역 변수로 구현 가능
        - `acquire 함수`: 임계 구역 잠그는 역할
            - 프로세스가 임계 구역에 진입하기 전에 호출하는 함수
            - if 임계 구역 잠겼다면 임계 구역 열릴 때까지 임계 구역 확인, else 열렸다면 임계 구역 잠금
            
            ```java
            acquire() {
            	while (lock == true)
            		;
            	lock = true;
            }
            ```
            
        - `release 함수`:
            - 프로세스가 임계구역 진입하기 전에 호출하는 함수
            - 현재 잠긴 임계 구역을 열어줌
            
            ```java
            release() {
            	lock = flase;
            }
            ```
            
        - acquire과 release 함수를 임계구역 전후로 호출함으로써 하나의 프로세스만 임계 구역에 진입 가능
- **세마포**: 자원이 여러 개 있는 상황에서도 적용이 가능한 동기화 도구
    - 간단한 구현 - wait, signal 함수 및 전역변수 S
        - `전역변수 S`: 임계 구역에 진입할 수 있는 프로세스 개수 나타내는 변수
        - `wait 함수`: 임계 구역에 들어가도 좋은지, 기다려야 할지 알려주는 함수
            
            ```java
            wait() {
            	while (S <= 0)     // 만일 임계 구역에 진입 가능한 프로세스 개수가 0 이하라면
            	;                  // 사용할 수 있는 자원이 있는지 반복적으로 확인하고
            	S--;               // 임계 구역 진입 가능한 프로세스 개수가 1 이상이라면 S 1 감소 & 임계구역 진입
            }
            ```
            
        - `signal 함수`: 임계 구역 앞에서 기다리는 프로세스에게 진입 허가 신호 주는 함수
            
            ```java
            signal() {
            	S++;        // 임계 구역에서의 작업을 마친 뒤 S를 1 증가시킴
            }
            ```
            
    - if) 3개의 프로세스 P1, P2, P3가 두 개의 공유자원에 순서대로 접근
        1. 프로세스 P1 wait 호출, S는 현재 2이므로 S 1 감소시키고 임계 구역 진입
        2. 프로세스 P2 wait 호출, S는 현재 1이므로 S 1 감소시키고 임계 구역 진입
        3. 프로세스 P3 wait 호출, S는 현재 0이므로 무한히 반복하며 S 확인
        4. 프로세스 P1 임계 구역 작업 종료, signal() 호출, S 1 증가
        5. 프로세스 P3이 S가 1이 됨 확인, S는 현재 1이므로 1 감소시키고 임계 구역 진입
- **바쁜 대기**: 위와 같이 lock을 지속적으로 확인해 보는 방식
    - → 뮤텍스 락 및 세마포 모두 해당, CPU 주기 낭비 문제 발생
    - 위를 해결하기 위한 세마포
        
        ```java
        wait() {
        	S--;
        	if (s < 0) {
        		add this process to Queue;      // 해당 프로세스를 PCB 대기 큐에 삽입
        		sleep();                        // 대기 상태로 접어듦
        	}
        }
        ```
        
        ```java
        signal() {
        	S++;
        	if (S <= 0) {
        		remove a process p from Queue;   // 대기 큐에 있는 프로세스 p 제거
        		wakeup(p);                       // 프로세스 p를 대기 상태 -> 준비 상태 전환
        	}
        }
        ```
        
    - if) 3개의 프로세스 P1, P2, P3가 두 개의 공유자원에 순서대로 접근
        1. 프로세스 P1 wait 호출, S 1 감소시키면 S는 1이므로 임계 구역 진입
        2. 프로세스 P2 wait 호출, S 1 감소시키면 S는 0이므로 임계 구역 진입
        3. 프로세스 P3 wait 호출, S 1 감소시키면 S -1이므로 본인의 PCB를 대기 큐에 넣고 대기 상태 전환
        4. 프로세스 P1 임계 구역 작업 종료, signal() 호출, S 1 증가하면 0이므로 대기 상태이던 P3 대기 큐에서 꺼내 준비 큐로 이동
        5. 깨어난 프로세스 P3 임계 구역 진입
        6. 프로세스 P2 임계 구역 작업 종료, signal() 호출, S 1 증가하면 1 
        7. 프로세스 P3 임계 구역 작업 종료, signal() 호출, S 1 증가하면 2
- **모니터**: 공유 자원 & 공유 자원에 접근하기 위한 인터페이스를 묶어 관리 → 프로세스가 인터페이스 통해서만 공유 자원에 접근하도록
    - 공유 자원을 다루는 인터페이스에 접근하기 위한 큐 생성, 모니터 안에 항상 *하나의 프로세스만* 들어오도록 하여 상호 배제를 위한 동기화 제공
        
        <img width=65% alt="image" src="https://github.com/user-attachments/assets/36c2d4bc-4374-4196-bb83-644bd6b3a79d" />

        
    - **조건 변수**: 특정 조건을 바탕으로 프로세스 실행 & 일시 중단 위해 사용
    - `wait 함수`: 호출한 프로세스의 상태 대기 상태 전환 & 일시적으로 조건 변수에 대한 대기 큐에 삽입
    - `signal 함수`: wait을 호출하여 큐에 삽입된 프로세스의 실행을 재개
    - 특정 프로세스가 아직 실행될 조건이 되지 않았다면 wait을 통해 실행 중단,
    특정 프로세스가 실행될 조건이 충족됐다면 signal을 통해 실행 재개

### 확인 문제

- #1. 뮤텍스 락 & 세마포에 대한 설명으로 옳지 않은 것을 고르세요.
    1. 뮤텍스 락은 임계 구역을 잠근 뒤 임계 구역에 진입함으로써 상호 배제를 위한 동기화를 이룹니다.
    2. 세마포는 공유 자원이 여러 개 있는 상황에서도 이용할 수 있습니다.
    3. 세마포를 이용해 프로세스 실행 순서 제어를 위한 동기화도 이룰 수 있습니다.
    4. 세마포를 이용하면 반드시 바쁜 대기를 해야 합니다.
    - 정답: 4번
- #2. 조건 변수 x와 y가 있다고 가정해 보겠습니다. 스레드 A는 실행 과정에서 x.wait를 호출하였고 스레드 B는 y.wait을 호출했습니다. 스레드 C가 y.signal을 호출했을 때 스레드 A와 B 중 실행이 재개되는 스레드는 무엇일까요?
    - 정답: B
- #3. 빈칸에 들어갈 알맞은 말을 보기에서 골라 써 보세요.
    
    > `보기` 실행 순서 제어, 상호 배제, 입출력 장치
    > 
    - 세마포를 이용하면 동시에 실행되는 프로세스 혹은 스레드 간에 (   ①   )를 위한 동기화와 (   ②   )를 위한 동기화를 할 수 있습니다.
    - 정답: ① 상호 배체, ② 실행 순서 제어
